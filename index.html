<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8" />
<title>Puzzle HackTX 15</title>
<!-- License: Public domain -->
<script>
function parse_urls() {
	var params = {},
		match,
		pl     = /\+/g, // Regex for replacing addition symbol with a space
		search = /([^&=]+)=?([^&]*)/g,
		decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
		query  = window.location.search.substring(1);

	while (match = search.exec(query))
		params[decode(match[1])] = decode(match[2]);
	return params;
}

var canvas;
var ctx;

var rows, cols;

// x, y, width, and height of the solved puzzle on the canvas (in pixels)
var puzzle_x, puzzle_y, puzzle_width, puzzle_height;

// factor that the source image's dimensions are scaled by
var scale_factor;

var pieces;
var piece_count;
var image;

function Piece(x, y, width, height, src_x, src_y, src_width, src_height,
	goal_x, goal_y) {
	// x and y are the only variables that change during gameplay;
	// the rest are precalculated values initialized in run()
	// (or more specifically, image.onload())
	this.x = x;
	this.y = y;
	this.width = width;
	this.height = height;
	this.src_x = src_x;
	this.src_y = src_y;
	this.src_width = src_width;
	this.src_height = src_height;
	this.goal_x = goal_x;
	this.goal_y = goal_y;
};

function draw_scene() {
	window.requestAnimationFrame(draw_scene);
	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight;
	ctx.fillStyle = '#ffffff';
	ctx.fillRect(0, 0, canvas.width, canvas.height);
	for (i = 0; i < piece_count; i++) {
		var p = pieces[i];
		ctx.drawImage(image, p.src_x, p.src_y, p.src_width, p.src_height,
			p.x, p.y, p.width, p.height);
	}
}

function run() {
	window.requestAnimationFrame =
		window.requestAnimationFrame || window.mozRequestAnimationFrame ||
		window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;

	canvas = document.getElementById('canvas');
	canvas.style.display = '';
	ctx = canvas.getContext('2d');

	memcanvas = document.createElement('canvas');
	memctx = memcanvas.getContext('2d');

	params = parse_urls();
	console.log("img: " + params['img'] + "\n"
		+ "rows: " + params['rows'] + "\n"
		+ "cols: " + params['cols'] + "\n");

	rows = params['rows'];
	cols = params['cols'];

	image = new Image();
	image.onload = function() {
		var canvas_width = window.innerWidth;
		var canvas_height = window.innerHeight;
		var i, j, n;
		var x, y, width, height, src_x, src_y, src_width, src_height;
		var p;

		scale_factor = 1;
		if (scale_factor*this.width > canvas_width)
			scale_factor = canvas_width / this.width;
		if (scale_factor*this.height > canvas_height)
			scale_factor = canvas_height / this.height;
		puzzle_width = scale_factor*this.width;
		puzzle_height = scale_factor*this.height;
		puzzle_x = (canvas_width - puzzle_width)/2
		puzzle_y = (canvas_height - puzzle_height)/2
		console.log("Window width: " + canvas_width + "\n"
			+ "Window height: " + canvas_height + "\n"
			+ "Image width: " + this.width + "\n"
			+ "Image height: " + this.height + "\n"
			+ "Scale factor: " + scale_factor + "\n"
			+ "Puzzle x: " + puzzle_x + "\n"
			+ "Puzzle y: " + puzzle_y + "\n"
			+ "Puzzle width: " + puzzle_width + "\n"
			+ "Puzzle height: " + puzzle_height + "\n");

		pieces = [];
		n = 0;
		for (i = 0; i < rows; i++) {
			y = Math.floor(i*puzzle_height/rows);
			height = Math.floor((i+1)*puzzle_height/rows) - y;
			src_y = Math.floor(i*this.height/rows);
			src_height = Math.floor((i+1)*this.height/rows) - src_y;

			for (j = 0; j < cols; j++) {
				x = Math.floor(j*puzzle_width/cols);
				width = Math.floor((j+1)*puzzle_width/cols) - x;
				src_x = Math.floor(j*this.width/cols);
				src_width = Math.floor((j+1)*this.width/cols) - src_x;
				
				pieces.push(new Piece(
					puzzle_x+x, puzzle_y+y,
					width, height,
					src_x, src_y,
					src_width, src_height,
					puzzle_x+x, puzzle_y+y));
				p = pieces[n];
				console.log("puzzle[" + n + "]:\n"
					+ "x: " + p.x + "\n"
					+ "y: " + p.y + "\n"
					+ "width: " + p.width + "\n"
					+ "height: " + p.height + "\n"
					+ "src_x: " + p.src_x + "\n"
					+ "src_y: " + p.src_y + "\n"
					+ "src_width: " + p.src_width + "\n"
					+ "src_height: " + p.src_height + "\n"
					+ "goal_x: " + p.goal_x + "\n"
					+ "goal_y: " + p.goal_y + "\n");
				n++;
			}
		}
		piece_count = rows*cols;

		draw_scene();
	}
	image.src = params['img'];
}
</script>
<style>
html, body {
	height: 100%;
	margin: 0;
	padding: 0;
}

#canvas {
	position: absolute;
	width: 100%;
	height: 100%;
	background: #000;
}
</style>
</head>
<body onload="run();">
<div>
<canvas id="canvas" style="display: none"></canvas>
</div>
</body>
</html>